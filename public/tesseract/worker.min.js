importScripts('https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/worker.min.js');

const worker = new Worker('tesseract-core.wasm.js', {
  workerType: 'module',
});

let initialized = false;

self.onmessage = async function(e) {
  const { jobId, data, action } = e.data;
  
  try {
    if (!initialized && action !== 'loadLanguage') {
      await worker.postMessage({ jobId, action: 'loadLanguage', data: 'eng+spa' });
      await worker.postMessage({ jobId, action: 'initialize', data: 'eng+spa' });
      initialized = true;
    }

    switch (action) {
      case 'recognize':
        worker.postMessage({ jobId, action, data });
        break;
        
      case 'terminate':
        worker.terminate();
        self.close();
        break;
    }
  } catch (error) {
    self.postMessage({
      jobId,
      status: 'error',
      error: error.message
    });
  }
};

worker.onmessage = function(e) {
  self.postMessage(e.data);
};

worker.onerror = function(e) {
  self.postMessage({
    status: 'error',
    error: e.message
  });
};
